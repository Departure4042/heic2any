<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HEIC Converter</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/spectre.css/0.5.9/spectre.min.css"
        integrity="sha512-9RIcp1f4CE6dEuYX9085tXaEbYd1ap04d2Av1ub/dwuT33WbfbHStDdQ+shKrp5wzZzleh5DOg+7ABSnaQP/nQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        .thumbnail {
            display: inline-block;
            margin: 10px;
            width: 150px;
            height: auto;
            border: 1px solid #ddd;
            padding: 5px;
        }

        .status {
            color: blue;
            font-size: 0.9em;
            margin: 10px 0;
        }
    </style>
</head>

<body>
    <div class="container grid-lg" style="text-align: center; margin-top: 50px;">
        <input class="form-input" type="file" id="inputFile" accept=".heic" multiple />
        <div class="columns">
            <div class="column col-sm-12 col-md-6">
                <label for="qualityInput">Quality (0-100%): </label>
                <input class="form-input" type="number" id="qualityInput" min="0" max="100" value="80" />Higher quality
                will take longer.
            </div>
            <div class="column col-sm-12 col-md-6">
                <label for="fileTypeSelect">Output File Type: </label>
                <select class="form-select" id="fileTypeSelect">
                    <option value="image/png" selected>PNG</option>
                    <option value="image/jpeg">JPEG</option>
                    <option value="image/gif">GIF</option>
                </select>
            </div>
        </div>
        <button class="btn btn-primary" onclick="convertFiles()">Convert</button>
        <button class="btn btn-secondary" id="downloadBtn" onclick="downloadAll()" disabled>Download All Converted
            Images</button>
        <div class="status" id="statusMessage"></div>
        <div class="progress">
            <div class="bar" id="progressBar" style="width: 0%;"></div>
        </div>
    </div>

    <div id="thumbnails" class="columns"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/heic2any/0.0.4/heic2any.min.js"
        integrity="sha512-VjmsArkf8Vv2yyvbXCyVxp+R3n4N2WyS1GEQ+YQxa7Hu0tx836WpY4nW9/T1W5JBmvuIsxkVH/DlHgp7NEMjDw=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"
        integrity="sha512-XMVd28F1oH/O71fzwBnV7HucLxVwtxf26XV8P4wPk26EDxuGZ91N8bsOttmnomcCD3CS5ZMRL50H0GgOHvegtg=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
        let convertedBlobs = [];
        let convertedFileNames = [];

        async function convertFiles() {
            const statusMessage = document.getElementById('statusMessage');
            const inputFile = document.getElementById('inputFile');
            const qualityInput = document.getElementById('qualityInput');
            const fileTypeSelect = document.getElementById('fileTypeSelect');
            const thumbnailsDiv = document.getElementById('thumbnails');

            thumbnailsDiv.innerHTML = ''; // Clear previous thumbnails
            convertedBlobs = []; // Clear previously converted blobs
            convertedFileNames = []; // Clear previously converted filenames

            if (inputFile.files.length === 0) {
                alert('Please select .HEIC files first.');
                return;
            }

            const quality = qualityInput.value / 100; // Convert percentage to a value between 0 and 1
            const fileType = fileTypeSelect.value;
            const fileExtension = fileType.split('/')[1];

            // Convert each selected file
            for (let index = 0; index < inputFile.files.length; index++) {
                const heicFile = inputFile.files[index];

                // Update status message
                statusMessage.textContent = `Converting file ${index + 1}...`;

                try {
                    const convertedBlob = await heic2any({
                        blob: heicFile,
                        toType: fileType,
                        quality: quality
                    });

                    convertedBlobs.push(convertedBlob);
                    convertedFileNames.push(heicFile.name.replace(/\.heic$/i, `.${fileExtension}`));

                    const columnDiv = document.createElement('div');
                    columnDiv.className = 'column col-4'; // Create a 3-column grid. Adjust col-4 to col-3 for 4 columns, col-2 for 6 columns, etc.

                    const figure = document.createElement('figure');
                    figure.className = "figure";

                    const img = document.createElement('img');
                    img.src = URL.createObjectURL(convertedBlob);
                    img.alt = heicFile.name; // Using the file name as the alt text
                    img.className = "thumbnail img-responsive"; // Added img-responsive
                    img.onclick = function () {
                        window.open(img.src, '_blank'); // Open the full-sized image in a new tab
                    };
                    figure.appendChild(img);

                    // Adding the file name as a caption:
                    const figCaption = document.createElement('figcaption');
                    figCaption.className = "figure-caption";
                    figCaption.textContent = heicFile.name; // Use the file name as the caption
                    figure.appendChild(figCaption);

                    columnDiv.appendChild(figure);
                    thumbnailsDiv.appendChild(columnDiv);

                } catch (error) {
                    console.error('Error converting one of the images:', error);
                }
            }

            // After all files have been converted
            statusMessage.textContent = 'Conversion complete!';
            document.getElementById('downloadBtn').disabled = false; // Enable the download button
        }

        function downloadAll() {
            const zip = new JSZip();

            convertedBlobs.forEach((blob, index) => {
                zip.file(convertedFileNames[index], blob);
            });

            zip.generateAsync({
                type: "blob"
            })
            .then((content) => {
                const link = document.createElement('a');
                link.href = URL.createObjectURL(content);
                link.download = 'converted_images.zip';
                link.click();
            });
        }
    </script>
    <div class="columns" style="margin-top: 30px; border-top: 1px solid #ddd; padding-top: 20px;">
        <div class="column col-sm-12 col-md-6" style="text-align: left;">
            <h2>About HEIC Converter</h2>
            <p>
                This web tool allows you to convert HEIC images to other popular formats like PNG, JPEG, and GIF. One of
                the primary advantages of this converter is its commitment to user privacy. Unlike many online
                converters, all image processing happens directly on your computer. This means that your images never
                leave your device, ensuring that your data remains private and secure.
            </p>
            <p>
                No uploads, no waiting for server responses, and most importantly, no potential privacy breaches. Your
                images remain yours, and only yours.
            </p>
            <p>
                Please note, this tool relies on scripts from CDNJS, which means an active internet connection is
                required for initial loading. These scripts are tamper-proof and delivered over secure channels,
                ensuring the integrity and security of the tool's functionality.
            </p>
        </div>
        <div class="column col-sm-12 col-md-6" style="text-align: left;">
            <h3>Resources and Source Code</h3>
            <table style="margin: 0 auto; border-collapse: collapse; width: 100%;">
                <thead>
                    <tr>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Library/Resource</th>
                        <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Link</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td style="border: 1px solid #ddd; padding: 8px;">heic2any Library</td>
                        <td style="border: 1px solid #ddd; padding: 8px;"><a href="https://cdnjs.com/libraries/heic2any"
                                target="_blank">cdnjs.com/libraries/heic2any</a></td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #ddd; padding: 8px;">jszip Library</td>
                        <td style="border: 1px solid #ddd; padding: 8px;"><a href="https://cdnjs.com/libraries/jszip"
                                target="_blank">cdnjs.com/libraries/jszip</a></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</body>

</html>
